#!/bin/sh
url="$1"

httpget() (
  if command -v curl >/dev/null 2>&1; then
    curlopts="-fL --output -"

    case "$1" in
    (http://*.onion/*|https://*.onion/*)
      curlopts="${curlopts} --socks5-hostname 127.0.0.1:9050"
    esac

    curl $curlopts "$1"
  else
    wget -O - "$1"
  fi
)

apply_base() {
  scheme="$1"
  host="$2"
  case "$url" in
  (//*) url="${scheme}:${url}";;
  (/*) url="${scheme}://${host}${url}";;
  esac
}

url="$1"

# we need an url/urn to operate
case "$url" in
(*:*) ;;
(*) echo "No scheme given" >&2; exit 1;;
esac

# rewrite HTML frontends of paste services to raw url
case "$url" in
(https://pastebin.com/raw/*)
  ;;
(https://pastebin.com/*)
  url=https://pastebin.com/raw/${1##https://pastebin.com/}
  ;;
(https://paste.debian.net/plain/*)
  ;;
(https://paste.debian.net/*)
  url=https://paste.debian.net/plain/${1##https://paste.debian.net/}
  ;;
esac

# fetch pdf's via scihub
case "$url" in
(doi:*|isbn:*)
  doi="${url#doi:}"
  doi="${doi#isbn:}"
  newurl=$(httpget "https://sci-hub.se/${doi}"|grep -o -E '(src|href)="?[^" ]*'|sed 's/^[^=]*=//;s/["'"\'"']//g'|grep '\.pdf'|head -n 1)
  test -n "${newurl}" && url="${newurl}" && apply_base https sci-hub.se
esac

httpget "$url"
