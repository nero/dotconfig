#!/bin/sh

case "$(uname -s)" in
(Linux)
  if test $(( $(cat /proc/sys/kernel/tainted 2>/dev/null || echo 0) & (4+32+128+512) )) -gt 0; then
    echo kdmg
  fi

  if ! test "$(stat -c "%i" /)" -gt 2; then
    test -d "/lib/modules/$(uname -r)" || echo "kver"
  fi

  if test -r /proc/pressure/cpu; then
    for i in cpu io memory; do
      test "$(awk '/some/ {gsub(/avg[0-9]*=/,"");printf("%d",$2)}' /proc/pressure/$i)" -gt 5 && echo ${i}_stall
    done
  fi
  ;;
esac

# print free diskspace if less than 100GB
df -k -P "$HOME" 2>/dev/null|awk '/^\// {if ($4<100*1024*1024) {printf("%dMB\n",$4/1024)}}'

# tell me about open tmux sessions
if command -v tmux >/dev/null 2>&1 && test -z "$TMUX"; then
  tmux ls -F 'tmux###S' 2>/dev/null
fi

if command -v gpg >/dev/null 2>&1; then
  gpg --list-secret-keys | awk '
BEGIN {
  limit=strftime("%Y-%m-%d", systime()+60*60*24*14)
}
/expires/ {
  gsub(/[\[\]]/," ")
  if(limit > $6) print($0)
}'
fi
