#!/bin/sh

case "$(uname -s)" in
(Linux)
  test -e /proc/sys/kernel/tainted && awk </proc/sys/kernel/tainted '
BEGIN{
  name[0]="TAINT_PROPRIETARY_MODULE"
  name[1]="TAINT_FORCED_MODULE"
  name[2]="TAINT_CPU_OUT_OF_SPEC"
  name[3]="TAINT_FORCED_RMMOD"
  name[4]="TAINT_MACHINE_CHECK"
  name[5]="TAINT_BAD_PAGE"
  name[6]="TAINT_USER"
  name[7]="TAINT_DIE"
  name[8]="TAINT_OVERRIDDEN_ACPI_TABLE"
  name[9]="TAINT_WARN"
  name[10]="TAINT_CRAP"
  name[11]="TAINT_FIRMWARE_WORKAROUND"
  name[12]="TAINT_OOT_MODULE"
  name[13]="TAINT_UNSIGNED_MODULE"
  name[14]="TAINT_SOFTLOCKUP"
  name[15]="TAINT_LIVEPATCH"
  name[16]="TAINT_AUX"
  name[17]="TAINT_FLAGS_COUNT"
}

{
  for (i = 1; i <= 17; i++) {
    if (and(2^i, $1) > 0) {
      print(name[i])
    }
  }
}
'

  if test "$(stat -c "%i" /)" -gt 2; then
    echo namespaced environment
  else
   test -d "/lib/modules/$(uname -r)" || echo "kernel module version mismatch"
  fi
  if test -r /proc/pressure/cpu; then
    test "$(awk '/some/ {gsub(/avg[0-9]*=/,"");printf("%d",$2)}' /proc/pressure/cpu)" -gt 20 && echo cpu stall
    test "$(awk '/full/ {gsub(/avg[0-9]*=/,"");printf("%d",$2)}' /proc/pressure/memory)" -gt 20 && echo memory stall
  fi
  ;;
esac

# print free diskspace if less than 1GB
df -k -P "$HOME" 2>/dev/null|awk '/^\// {if ($4<10*1024*1024) {printf("%d MB available\n",$4/1024)}}'
