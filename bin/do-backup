#!/bin/sh
# filecat/ folder is used to classify files for not being backupped
# if they exist on the remote, they are deleted there.

r() {
  rsync -avux --modify-window=2 --no-specials --progress \
    -e "ssh -o'ControlMaster auto' -o'ControlPath ~/.ssh/%r@%h:%p.sck' -o'ControlPersist 10'" "$@"
}

# create a shallow copy of the home directory
r --delete --delete-excluded \
  --exclude-from="$XDG_CONFIG_HOME/filecat/ephemeral" \
  --exclude-from="$XDG_CONFIG_HOME/filecat/sensitive" \
  --exclude=/archive \
  --exclude=/storage \
  "$HOME/" storage:home/"$(uname -n)"

# add to the archive
r "$HOME/archive" storage:.
