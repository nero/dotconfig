#!/bin/sh
dest=${HOME?}/archive

if test -z "$1"; then
  cd "$HOME" || exit 1
  # move away lingering files
  find -L . Downloads -maxdepth 1 -type f ! -name '.*' -exec "$0" {} \;
  # delete remaining empty directories
  find -L . Downloads -maxdepth 1 -type d -empty -exec rmdir {} \;
  exit
fi

while test -n "$1"; do
  name=${1##*/}

  folder=$(printf "%s\n" "$name"|awk -v d="$folder" -F- '/^[0-9]+-[01][0-9]-[0-3][0-9]-/ {print("/"$1"/"$2)}')
  test -n "$folder" || folder=$(date +'/%Y/%m')

  unset num
  while test -e "${dest}${folder}/${name}${num:+_$num}"; do
    num=$(( $num + 1 ))
  done

  mkdir -p "${dest}${folder}"
  mv -v "$1" "${dest}${folder}/${name}${num:+_$num}"
  shift
done
