#!/bin/sh
set -e

test -f "${HOME?}"/.config/user-dirs.dirs && . "${HOME}"/.config/user-dirs.dirs

# Collect mode: put away files from desktop and downloads dir
if test -z "$1"; then
  # move away lingering files
  find -L "${HOME}" "${XDG_DESKTOP_DIR:-~/Desktop}" "${XDG_DOWNLOAD_DIR:-~/Downloads}" -maxdepth 1 -type f \
    ! -name '.*' \
    ! -name '*.url' \
    ! -name '*.desktop' \
    ! -name '*.lnk' \
    ! -name 'desktop.ini' \
    ! -iname 'ntuser.*' \
    -exec "$0" {} \; 2>/dev/null
  exit
fi

# Put away specifically named files
now=$(date +'%Y/%m')

for src in "$@"; do
  name=${src##*/}

  dest=~/archive/$now
  mkdir -p "${dest}"

  (
    set -x
    mv "${src}" "${dest}/${name}" || mv "${src}" "${dest}/${name}.$$"
  )
done
