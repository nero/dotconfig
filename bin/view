#!/bin/sh
# Syntax: view (url | path)
# Figure out how to display a file.
# also, downloaded files are cached, so i can view them again for two days
# without having to re-download them.
# usually this spawns a window that needs to be manually closed.

# create a temporary file to store contents in
cachefile() {
  hash=$(printf "%s" "$1"|md5sum|cut -d' ' -f1)
  name="${XDG_CACHE_HOME:-$HOME/.cache}"/urls/"$hash"
  mkdir -p "${name%/*}"
  printf "%s\n" "$name"
}

# load url via command
# contents are transferred via stdout
fetch_via() {
  file=$(cachefile "$url")
  test -s "$file" && return
  "$@" > "${file}.$$" && mv "${file}.$$" "${file}" || rm "${file}.$$"
}

# long-running commands that require xorg
gui() {
  test -n "$DISPLAY" || return
  printf '%s\n' "$type"|grep -qiE "$1" || return
  shift
  command -v "$1" >/dev/null 2>&1 || return
  setsid "$@" &
}

# long-running commands
cmd() {
  printf '%s\n' "$type"|grep -qiE "$1" || return
  shift
  command -v "$1" >/dev/null 2>&1 || return
  exec "$@"
}

# commands that dump presentation to stdout and exit
dmp() {
  printf '%s\n' "$type"|grep -qiE "$1" || return
  shift
  command -v "$1" >/dev/null 2>&1 || return
  (
    printf "[%s]\n" "$type"
    "$@"
  ) | less
  exit 0
}

# delete older files so they dont pile up
find "${XDG_CACHE_HOME:-$HOME/.cache}"/urls -mtime +2 -delete 2>/dev/null

if test "$1" = "-" ; then
  url=$(head -n 1)
else
  url="$1"
fi

# rewrite for shitty paste services
case "$url" in
https://pastebin.com/raw/*)
  ;;
https://pastebin.com/*)
  url=https://pastebin.com/raw/${1##https://pastebin.com/}
  ;;
https://paste.debian.net/*)
  url=https://paste.debian.net/plain/${1##https://paste.debian.net/}
  ;;
esac

# some urls have special handling
case "$url" in
https://www.youtube.com/watch?v=*|https://youtu.be/*|https://hooktube*)
  exec mpv --loop=inf "$url"
  ;;
http://*.onion/*|https://*.onion/*)
  fetch_via curl -Lvvv --socks5-hostname 127.0.0.1:9050 "$url"
  ;;
http://*|https://*|gopher:*)
  fetch_via curl -Lvvv "$url"
  ;;
file://*)
  file="${url#file://}"
  ;;
/*)
  file="$url"
  url="file://$url"
  ;;
*)
  file="$PWD/$url"
  url="file://$PWD/$url"
  ;;
esac

if ! test -s "$file" || ! test -f "$file"; then
  echo "Failed to access file" >&1
  head -n 1
  exit 1
fi

type=$(file -z -L -b "$file")
echo "$type"

# gui = requires xorg
# cmd = tui application
# dmp = displayed by converting to text
# First match wins

gui 'PDF document' mupdf-gl -I "$file"
gui 'PDF document' mupdf -I "$file"
gui 'HTML document|PDF document' firefox "$url"
gui 'HTML document' qutebrowser "$url"
cmd 'HTML document' w3m -T text/html "$url"
cmd 'HTML document' lynx "$url"
dmp 'HTML document' sed -e 's/<[^>]*\(>\|$\)//g;/^\s*$/d' "$file"
cmd 'shell script' nano --view -Y sh "$file"
gui 'video|ISO Media|WebM|Matroska|GIF image data' mpv --loop-file=inf "$file"
cmd 'audio|layer III' mpv --no-video --loop-file=inf "$file"
gui 'image data' feh --output-dir "$HOME" "$file"
cmd 'image data' cacaview "$file"
dmp 'tar archive' tar -tf "$file"
dmp 'PEM certificate request' openssl req -in "$file" -text -noout -verify
dmp 'PEM certificate' openssl x509 -in "$file" -text -noout
gui 'PEM certificate' gcr-viewer "$file"
dmp 'text' cat -v "$file"
dmp '.*' hexdump -Cv "$file"
