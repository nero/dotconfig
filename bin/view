#!/bin/sh
# Syntax: view (url | path)
# Figure out how to display a file.
# also, downloaded files are caches, so i can view them again for two days
# without having to re-download them.
# usually this spawns a window that needs to be manually closed.

cachefile() {
  hash=$(printf "%s" "$1"|md5sum|cut -d' ' -f1)
  name="${XDG_CACHE_HOME:-$HOME/.cache}"/urls/"$hash"
  mkdir -p "${name%/*}"
  printf "%s\n" "$name"
}

fetch_via() {
  file=$(cachefile "$url")
  test -s "$file" && return
  "$@" > "${file}.$$" && mv "${file}.$$" "${file}"
}

# long-running commands that require xorg
gui() {
  test -n "$DISPLAY" || return
  cmd "$@"
}

# long-running commands
cmd() {
  printf '%s\n' "$type"|grep -qiE "$1" || return
  shift
  command -v "$1" >/dev/null 2>&1 || return
  exec "$@"
}

# commands that dump presentation to stdout and exit
dmp() {
  printf '%s\n' "$type"|grep -qiE "$1" || return
  shift
  command -v "$1" >/dev/null 2>&1 || return
  (
    echo "$type"
    "$@"
  ) | less
  exit 0
}

find "${XDG_CACHE_HOME:-$HOME/.cache}"/urls -mtime +2 -delete

url="$1"
case "$url" in
https://pastebin.com/*)
  url=https://pastebin.com/raw/${1##https://pastebin.com/}
  ;;
esac

case "$url" in
https://www.youtube.com/watch?v=*|https://youtu.be/*|https://hooktube*)
  exec mpv --loop=inf "$url"
  ;;
http://*.onion/*|https://*.onion/*)
  fetch_via curl -sLvvv --socks5-hostname 127.0.0.1:9050 "$url"
  ;;
http://*|https://*|gopher:*)
  fetch_via curl -sLvvv "$url"
  ;;
file://*)
  file="${url#file://}"
  ;;
/*)
  file="$file"
  url="file://$file"
  ;;
*)
  file="$PWD/$url"
  url="file://$PWD/$url"
  ;;
esac

if ! test -s "$file" || ! test -f "$file"; then
  echo "Failed to access file" >&1
  head -n 1
  exit 1
fi

type=$(file -L -b "$file")
echo "$type"

gui 'HTML document|PDF document' firefox "$url"
cmd 'HTML document' w3m "$url"
cmd 'HTML document' lynx "$url"
dmp 'HTML document' sed -e 's/<[^>]*\(>\|$\)//g;/^\s*$/d' "$file"
cmd 'shell script' nano --view -Y sh "$file"
gui 'image data' feh -. "$file"
cmd 'image data' cacaview "$file"
gui 'video' mpv --loop-file=inf "$file"
cmd 'audio' mpv --no-video --loop-file=inf "$file"
cmd 'text' less "$file"
dmp '.*' hexdump -Cv "$file"
