#!/bin/sh
set -e

cd "$(dirname "$0")"
test -x ./install
repo=${PWD#$HOME/}
PATH=$PWD/bin:$PATH

cd "${HOME?}"

# we must be at .config or have .config point to us
if ! test "$repo" = .config; then
  test -h .config || rotate .config
  ln -sfn "$repo" .config
fi

# Install dotfiles normally
for f in "$repo"/*/dot.*; do
  c=${f%/*}
  command -v "${c##*/}" >/dev/null 2>&1 && ln -sfn "$f" ".${f#*/dot.}"
done

set -e

keytype=ed25519
key=${HOME:?}/.ssh/id_${keytype}
if test -e "${key}"; then
  test -e "${key}.pub" || ssh-keygen -y -f "${key}" >"${key}.pub" || rm "${key}.pub"

  url="https://w1r3.net/etc/install?k=$(cut -d" " -f2 "${key}".pub)&u=$LOGNAME&n=$(uname -n)"
  wget -q -O - "$url" || qrencode -tutf8 "$url"
fi
