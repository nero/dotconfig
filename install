#!/bin/sh
set -e

cd "$(dirname "$0")"
test -x ./install
repo=${PWD#${HOME%/}/}
PATH=$PWD/bin:$PATH

cd "${HOME?}"

# Make sure we are at ~/.config
case "$repo" in
(.config)
  # awesome, we are in the right location already
  ;;
(.config/*)
  # someone braindead (gitpod, coder) cloned us below .config, now we cannot operate on ~/.config without rugpulling ourselves
  # move ourselves over existing .config
  mv "$repo"/.git "$repo"/* .config/
  ;;
(*)
  # anywhere else
  test -h .config || rotate .config
  ln -sfn "$repo" .config
  ;;
esac

# Install dotfiles normally
for f in .config/*/dot.*; do
  c=${f%/*}
  command -v "${c##*/}" >/dev/null 2>&1 && ln -sfn "$f" ".${f#*/dot.}"
done

set -e

keytype=ed25519
key=${HOME:?}/.ssh/id_${keytype}
if test -e "${key}"; then
  test -e "${key}.pub" || ssh-keygen -y -f "${key}" >"${key}.pub" || rm "${key}.pub"

  curl -T "${key}.pub" https://w1r3.net/ssh/submit
fi
