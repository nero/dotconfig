#!/bin/sh
die() {
  echo "$1" >&2
  exit 1
}

command_exists() {
  command -v "$1" >/dev/null 2>&1
}

sym() {
  test -e "$GIT_DIR"/"$2"
  test -f "$1" && ! test -L "$1" && mv "$1" "$1.old"
  ln -sfn "$GIT_DIR"/"$2" "$1"
}

del() {
  test -e "$1" && mv "$1" "$1.old"
}

test -z "$GIT_DIR" && GIT_DIR="$(dirname "$PWD/$0")"
test -z "$GIT_DIR" && die "GIT_DIR not set"
test -d "$GIT_DIR" || die "GIT_DIR invalid"

cd "$HOME"
GIT_DIR=${GIT_DIR#$HOME/}

# startup files for shells
sym .profile profile
case "$SHELL" in
(*/bash)
  del .bash_profile
  del .bash_logout
  sym .bashrc env
  ;;
(*/zsh)
  sym .zprofile profile
  sym .zshrc env
  ;;
esac

# automatic invocation of this script on git checkout
if test -d "$GIT_DIR"/.git; then
  ln -sfn ../../install "$GIT_DIR"/.git/hooks/post-checkout
fi

# compile & install my own terminal types
# tic is part of ncurses
if command_exists tic; then
  for i in "$GIT_DIR"/terminfo/*.info; do
    tic "$i"
  done
fi

# tmux config
command_exists tmux && sym .tmux.conf tmux/tmux.conf
